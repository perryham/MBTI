<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MBTI Executive Assessment</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'brand-blue': '#a8bbe8',
                        'brand-mint': '#8fd6bd',
                        'brand-pear': '#b7dd79',
                        'brand-coral': '#ff8674',
                        'brand-yellow': '#fbdb65',
                        'brand-black': '#000000',
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #ffffff; color: #000000; }
        .fade-in { animation: fadeIn 0.4s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .option-btn:hover { border-color: #000000; background-color: #f9fafb; }
    </style>
</head>
<body class="min-h-screen">

    <div id="app" class="max-w-3xl mx-auto px-4 py-12">
        <!-- Header -->
        <header class="mb-10 flex justify-between items-end border-b border-brand-black pb-6">
            <div>
                <h1 class="text-2xl font-bold tracking-tight text-brand-black uppercase">Operational leadership assessment</h1>
                <p class="text-slate-500 text-sm mt-1">Metrolinx Operations Business Services</p>
            </div>
            <div id="progress-text" class="text-slate-400 text-xs font-bold uppercase tracking-widest hidden">
                Question 1 / 70
            </div>
        </header>

        <!-- Progress Bar -->
        <div id="progress-container" class="w-full h-2 bg-slate-100 rounded-full mb-12 overflow-hidden hidden">
            <div id="progress-bar" class="h-full bg-brand-mint transition-all duration-300 ease-out" style="width: 0%"></div>
        </div>

        <!-- Registration Card -->
        <div id="registration-card" class="bg-white rounded-2xl border border-slate-200 p-8 md:p-12 mb-8 fade-in">
            <h2 class="text-xl font-bold text-brand-black mb-6">Participant registration</h2>
            <div class="space-y-6">
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-2">Full name</label>
                    <input type="text" id="reg-name" class="w-full p-4 rounded-lg border border-slate-200 focus:border-brand-black outline-none transition-all" placeholder="Enter your full name">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-2">Email address</label>
                    <input type="email" id="reg-email" class="w-full p-4 rounded-lg border border-slate-200 focus:border-brand-black outline-none transition-all" placeholder="name@metrolinx.com">
                </div>
                <button id="start-btn" class="w-full py-4 bg-brand-black text-white rounded-lg font-bold hover:opacity-90 transition-opacity">
                    Begin assessment
                </button>
            </div>
        </div>

        <!-- Question Container -->
        <div id="question-card" class="hidden bg-white rounded-2xl border border-slate-200 p-8 md:p-12 mb-8 fade-in">
            <h2 id="question-text" class="text-xl md:text-2xl font-medium text-brand-black mb-10 leading-snug"></h2>
            <div id="options-container" class="space-y-3"></div>
        </div>

        <!-- Results Container -->
        <div id="results-card" class="hidden bg-white rounded-2xl border border-slate-200 overflow-hidden fade-in">
            <div class="bg-brand-black p-10 text-white text-center">
                <h2 class="text-2xl font-bold mb-2 uppercase tracking-tight">Assessment profile</h2>
                <p id="result-display-name" class="font-medium text-brand-mint text-lg"></p>
                <p id="result-display-email" class="text-slate-400 text-sm"></p>
            </div>
            
            <div class="p-8">
                <div class="flex flex-col md:flex-row items-center gap-10 mb-10">
                    <div id="type-badge" class="w-44 h-44 rounded-full bg-brand-yellow flex items-center justify-center border-4 border-brand-black text-5xl font-black text-brand-black shrink-0"></div>
                    <div>
                        <h3 id="type-title" class="text-2xl font-bold mb-3 text-brand-black"></h3>
                        <p id="type-summary" class="text-slate-600 leading-relaxed italic border-l-4 border-brand-mint pl-4">
                            Strategic operational profile for data governance.
                        </p>
                    </div>
                </div>

                <div id="scores-grid" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-10"></div>

                <!-- Type Definition Section -->
                <div class="bg-slate-50 rounded-xl p-6 border border-slate-200 mb-6">
                    <h4 class="font-bold text-brand-black mb-4 uppercase text-xs tracking-widest">Type definition</h4>
                    <div id="type-definition" class="text-sm text-slate-700 leading-relaxed space-y-4"></div>
                </div>

                <!-- Work Style Section -->
                <div class="bg-white rounded-xl p-6 border-2 border-brand-mint mb-10">
                    <h4 class="font-bold text-brand-black mb-4 uppercase text-xs tracking-widest">Professional work style</h4>
                    <div id="work-style-analysis" class="text-sm text-slate-700 leading-relaxed space-y-4"></div>
                </div>

                <div class="flex flex-col sm:flex-row gap-4">
                    <button id="download-btn" class="flex-1 py-4 bg-brand-black text-white rounded-lg font-bold flex items-center justify-center gap-2 transition-transform active:scale-95">
                        Download assessment report
                    </button>
                    <button onclick="window.location.reload()" class="flex-1 py-4 bg-slate-100 text-slate-700 rounded-lg font-bold">
                        Restart
                    </button>
                </div>
            </div>
        </div>

        <footer id="assessment-footer" class="flex justify-between items-center text-slate-400 text-xs px-2 mt-4">
            <button id="prev-btn" class="hover:text-brand-black disabled:opacity-0 font-bold tracking-widest" disabled>← PREVIOUS</button>
            <div id="footer-context" class="italic">Enterprise Assessment Engine v4.0</div>
        </footer>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'mbti-assessment-perry';

        const LEADERSHIP_DICTIONARY = {
            "INTJ": {
                title: "Architect",
                definition: "Strategic thinkers with an internal plan for every scenario. They prioritize logic, objective data, and long-term vision over short-term social consensus.",
                workStyle: "They thrive in data governance by building structured frameworks and complex metadata lineage. They are stabilizers who value enterprise standards and have zero patience for process vagueness or political obscurity."
            },
            "ENTJ": {
                title: "Commander",
                definition: "Bold, imaginative, and strong-willed leaders. They are natural organizers who excel at translating complex problems into actionable roadmaps.",
                workStyle: "In operations, they act as decisive operators who operationalize data quality checks and enforce governance standards across cross-functional teams with authority."
            },
            "ISTJ": {
                title: "Logistician",
                definition: "Practical and fact-minded individuals. They value reliability, tradition, and established processes above all else.",
                workStyle: "They are the bedrock of data quality management. Their work style is characterized by extreme detail-orientation and a commitment to documented standards and predictable cycles."
            },
            "ESTJ": {
                title: "Executive",
                definition: "Excellent administrators who are unsurpassed at managing things or people. They prioritize clear rules and organizational hierarchy.",
                workStyle: "They excel in building full governance operating models and leading Lean A3 projects. They prioritize quantified results and expect high competence from all project stakeholders."
            },
            "INTP": {
                title: "Logician",
                definition: "Innovative inventors with an unquenchable thirst for knowledge. They focus on internal logical consistency and conceptual integrity.",
                workStyle: "Highly valuable in operational technology research. They prefer solving complex analytics governance problems but require structured reporting lines to remain focused on delivery."
            },
            "ENTP": {
                title: "Debater",
                definition: "Smart and curious thinkers who cannot resist an intellectual challenge. They are adaptable and thrive on exploring new possibilities.",
                workStyle: "They are effective at identifying gaps in enterprise transitions. They thrive in building automations using the Power Platform but benefit from partnering with a stabilizer to finalize long-term standards."
            },
            "INFJ": {
                title: "Advocate",
                definition: "Quiet and mystical, yet very inspiring and tireless idealists. They possess a deep sense of integrity and a desire to help others.",
                workStyle: "In governance, they excel at leading cross-functional work where privacy and ethics are paramount. They advocate for data standards as a means to protect organizational and customer integrity."
            },
            "ENFJ": {
                title: "Protagonist",
                definition: "Charismatic and inspiring leaders. They are natural motivators who excel at building consensus and navigating organizational politics.",
                workStyle: "They are ideal for managing the human element of high-level organizational shifts. They bridge the gap between technical DG standards and departmental adoption through influence."
            },
            "ISTP": {
                title: "Virtuoso",
                definition: "Bold and practical experimenters, masters of all kinds of tools. They prefer to solve problems through direct action and technical application.",
                workStyle: "Expert in building automations in Databricks or Office Scripts. Their work style is focused on root cause analysis and immediate technical resolution of data quality issues."
            },
            "ISFP": {
                title: "Adventurer",
                definition: "Flexible and charming artists, always ready to explore and experience something new. They value personal space and living in the moment.",
                workStyle: "They bring a unique perspective to customer analytics and visualization. They work best in environments with low political chaos and clear, supportive boundaries."
            },
            "INFP": {
                title: "Mediator",
                definition: "Poetic, kind, and altruistic people. They are guided by their inner values and are eager to help others reach their potential.",
                workStyle: "They support divisional governance by ensuring that metadata and lineage serve the larger organizational purpose. They value clarity of intent and empathetic leadership."
            },
            "ENFP": {
                title: "Campaigner",
                definition: "Enthusiastic, creative, and sociable free spirits. They see possibilities everywhere and are energized by new ideas.",
                workStyle: "Excellent at social-driven change management. They can generate excitement for new enterprise standards but require structured frameworks to ensure long-term stability."
            },
            "ESTP": {
                title: "Entrepreneur",
                definition: "Smart, energetic, and very perceptive people. They truly enjoy living on the edge and respond quickly to immediate crises.",
                workStyle: "In operations, they are effective 'troubleshooters' for CAD/AVL or ServiceNow issues. They prefer dynamic, hands-on problem solving over long-term documentation projects."
            },
            "ESFP": {
                title: "Entertainer",
                definition: "Spontaneous, energetic, and enthusiastic people. They thrive in social settings and value immediate engagement.",
                workStyle: "They improve team dynamics in high-stress environments. They work best when technical standards are translated into clear, engaging, and collaborative processes."
            },
            "ISFJ": {
                title: "Defender",
                definition: "Very dedicated and warm protectors. They are reliable and value harmony, often working tirelessly in the background.",
                workStyle: "They are the backbone of RIM and customer data maintenance. They ensure that data quality checks are performed with consistency and care, valuing predictable work cycles."
            },
            "ESFJ": {
                title: "Consul",
                definition: "Extraordinarily caring, social, and popular people. They are eager to help and value cooperation and clear social order.",
                workStyle: "They excel in project coordination for RTSI and MySafety initiatives. They ensure that enterprise transitions are handled with attention to both process and people."
            }
        };

        const QUESTIONS = [
            { id: 1, text: "In a professional setting, do you:", options: [{ text: "Prefer to interact with a wide range of people", type: "E" }, { text: "Prefer to speak with a few trusted colleagues", type: "I" }] },
            { id: 2, text: "When solving a problem, do you prioritize:", options: [{ text: "Facts and objective data", type: "S" }, { text: "Concepts and future possibilities", type: "N" }] },
            { id: 3, text: "Is it more critical to avoid:", options: [{ text: "Losing track of the details", type: "S" }, { text: "Losing track of the big picture", type: "N" }] },
            { id: 4, text: "In leadership, do you value:", options: [{ text: "Logical fairness", type: "T" }, { text: "Team harmony", type: "F" }] },
            { id: 5, text: "Are you more motivated by:", options: [{ text: "A rational argument", type: "T" }, { text: "A meaningful goal", type: "F" }] },
            { id: 6, text: "When managing a project, do you:", options: [{ text: "Stick to a firm schedule", type: "J" }, { text: "Adapt as circumstances change", type: "P" }] },
            { id: 7, text: "Do you prefer making decisions:", options: [{ text: "Quickly to finalize the matter", type: "J" }, { text: "Slowly to keep options open", type: "P" }] },
            { id: 8, text: "After a day of meetings, do you feel:", options: [{ text: "Energized by the activity", type: "E" }, { text: "Ready for quiet work", type: "I" }] },
            { id: 9, text: "Do you prefer teammates who are:", options: [{ text: "Down-to-earth and practical", type: "S" }, { text: "Creative and insightful", type: "N" }] },
            { id: 10, text: "Are you more interested in:", options: [{ text: "Operational realities", type: "S" }, { text: "Strategic trends", type: "N" }] },
            { id: 11, text: "When evaluating performance, do you lead with:", options: [{ text: "Objective standards", type: "T" }, { text: "Individual context", type: "F" }] },
            { id: 12, text: "Is your communication style more:", options: [{ text: "Direct and detached", type: "T" }, { text: "Inclusive and warm", type: "F" }] },
            { id: 13, text: "Do you prefer your calendar to be:", options: [{ text: "Well-organized", type: "J" }, { text: "Flexible", type: "P" }] },
            { id: 14, text: "Does it bother you more to be:", options: [{ text: "Unfinished", type: "J" }, { text: "Restricted", type: "P" }] },
            { id: 15, text: "In a new department, do you:", options: [{ text: "Seek to meet everyone", type: "E" }, { text: "Focus on your immediate team", type: "I" }] },
            { id: 16, text: "In daily tasks, are you likely to:", options: [{ text: "Follow established standards", type: "S" }, { text: "Try an experimental method", type: "N" }] },
            { id: 17, text: "In messaging, should leaders be:", options: [{ text: "Literal and specific", type: "S" }, { text: "Visionary and metaphorical", type: "N" }] },
            { id: 18, text: "Which is more important to you:", options: [{ text: "A correct outcome", type: "T" }, { text: "A happy team", type: "F" }] },
            { id: 19, text: "Are you more comfortable with:", options: [{ text: "Logic-based choices", type: "T" }, { text: "Value-based choices", type: "F" }] },
            { id: 20, text: "Do you prefer a project to be:", options: [{ text: "Completed and closed", type: "J" }, { text: "Open for continuous improvement", type: "P" }] },
            { id: 21, text: "Are you naturally more:", options: [{ text: "Methodical", type: "J" }, { text: "Spontaneous", type: "P" }] },
            { id: 22, text: "When starting a call, do you:", options: [{ text: "Just jump into the conversation", type: "E" }, { text: "Mentally prepare what to say", type: "I" }] },
            { id: 23, text: "Are facts more useful for:", options: [{ text: "Defining the current state", type: "S" }, { text: "Supporting a theory", type: "N" }] },
            { id: 24, text: "Do you find abstract thinkers:", options: [{ text: "Sometimes impractical", type: "S" }, { text: "Highly valuable", type: "N" }] },
            { id: 25, text: "Are you primarily:", options: [{ text: "Analytical", type: "T" }, { text: "Compassionate", type: "F" }] },
            { id: 26, text: "Which leadership trait is worse:", options: [{ text: "Lack of logic", type: "T" }, { text: "Lack of empathy", type: "F" }] },
            { id: 27, text: "Should workflows be:", options: [{ text: "Planned in detail", type: "J" }, { text: "Defined as we go", type: "P" }] },
            { id: 28, text: "Do you prefer:", options: [{ text: "A fixed commitment", type: "J" }, { text: "A tentative agreement", type: "P" }] },
            { id: 29, text: "In a meeting, do you:", options: [{ text: "Share your ideas early", type: "E" }, { text: "Listen to the whole discussion first", type: "I" }] },
            { id: 30, text: "Do you rely on:", options: [{ text: "Past experience", type: "S" }, { text: "Future intuition", type: "N" }] },
            { id: 31, text: "Is it more vital for staff to be:", options: [{ text: "Effective and useful", type: "S" }, { text: "Creative and innovative", type: "N" }] },
            { id: 32, text: "When deciding, do you prioritize:", options: [{ text: "Rules and policies", type: "T" }, { text: "People and feelings", type: "F" }] },
            { id: 33, text: "Are you naturally more:", options: [{ text: "Straightforward", type: "T" }, { text: "Diplomatic", type: "F" }] },
            { id: 34, text: "Which trait is better:", options: [{ text: "Being organized", type: "J" }, { text: "Being adaptable", type: "P" }] },
            { id: 35, text: "Do you prefer a plan that is:", options: [{ text: "Finalized", type: "J" }, { text: "Drafted", type: "P" }] },
            { id: 36, text: "Does large-group interaction:", options: [{ text: "Excite you", type: "E" }, { text: "Drain you", type: "I" }] },
            { id: 37, text: "Are you more often:", options: [{ text: "Practical", type: "S" }, { text: "Fanciful", type: "N" }] },
            { id: 38, text: "Do you focus on:", options: [{ text: "How things work", type: "S" }, { text: "How things could work", type: "N" }] },
            { id: 39, text: "Is it more satisfying to be:", options: [{ text: "Correct in your logic", type: "T" }, { text: "Agreed on by the group", type: "F" }] },
            { id: 40, text: "Do you decide with your:", options: [{ text: "Head", type: "T" }, { text: "Heart", type: "F" }] },
            { id: 41, text: "Do you prefer a work schedule that is:", options: [{ text: "Fixed", type: "J" }, { text: "Open", type: "P" }] },
            { id: 42, text: "Do you look for:", options: [{ text: "Stability", type: "J" }, { text: "Change", type: "P" }] },
            { id: 43, text: "Do you prefer:", options: [{ text: "A large network", type: "E" }, { text: "A small circle", type: "I" }] },
            { id: 44, text: "Do you trust:", options: [{ text: "Demonstrated results", type: "S" }, { text: "Underlying principles", type: "N" }] },
            { id: 45, text: "Are you more interested in:", options: [{ text: "Delivery", type: "S" }, { text: "Design", type: "N" }] },
            { id: 46, text: "Which praise is better:", options: [{ text: " 'You are very rational.' ", type: "T" }, { text: " 'You are very kind.' ", type: "F" }] },
            { id: 47, text: "Do you value being:", options: [{ text: "Unwavering", type: "T" }, { text: "Devoted", type: "F" }] },
            { id: 48, text: "Do you prefer a:", options: [{ text: "Firm decision", type: "J" }, { text: "Tentative decision", type: "P" }] },
            { id: 49, text: "Are you more comfortable:", options: [{ text: "Once a plan exists", type: "J" }, { text: "While exploring ideas", type: "P" }] },
            { id: 50, text: "In a room of strangers, do you:", options: [{ text: "Start a conversation", type: "E" }, { text: "Wait to be approached", type: "I" }] },
            { id: 51, text: "Do you trust:", options: [{ text: "Your experience", type: "S" }, { text: "Your hunch", type: "N" }] },
            { id: 52, text: "Are you more:", options: [{ text: "Realistic", type: "S" }, { text: "Conceptual", type: "N" }] },
            { id: 53, text: "Do you admire:", options: [{ text: "Logical minds", type: "T" }, { text: "Empathetic hearts", type: "F" }] },
            { id: 54, text: "Are you naturally:", options: [{ text: "Fair", type: "T" }, { text: "Sympathetic", type: "F" }] },
            { id: 55, text: "Is it better to:", options: [{ text: "Prepare in advance", type: "J" }, { text: "Respond as it happens", type: "P" }] },
            { id: 56, text: "Should targets be:", options: [{ text: "Fixed", type: "J" }, { text: "Renegotiable", type: "P" }] },
            { id: 57, text: "When your phone rings, do you:", options: [{ text: "Pick up immediately", type: "E" }, { text: "Screen the call", type: "I" }] },
            { id: 58, text: "Do you prize:", options: [{ text: "Common sense", type: "S" }, { text: "Creativity", type: "N" }] },
            { id: 59, text: "Do you focus on:", options: [{ text: "The fundamentals", type: "S" }, { text: "The nuances", type: "N" }] },
            { id: 60, text: "Which error is worse:", options: [{ text: "Being too detached", type: "T" }, { text: "Being too personal", type: "F" }] },
            { id: 61, text: "Are you more:", options: [{ text: "Logical", type: "T" }, { text: "Emotional", type: "F" }] },
            { id: 62, text: "Do you prefer a life that is:", options: [{ text: "Ordered", type: "J" }, { text: "Flexible", type: "P" }] },
            { id: 63, text: "Is your workflow more:", options: [{ text: "Standardized", type: "J" }, { text: "Ad-hoc", type: "P" }] },
            { id: 64, text: "Are you easier to:", options: [{ text: "Understand quickly", type: "E" }, { text: "Understand over time", type: "I" }] },
            { id: 65, text: "Do you prefer info that is:", options: [{ text: "Literal", type: "S" }, { text: "Interpretive", type: "N" }] },
            { id: 66, text: "Is it harder for you to:", options: [{ text: "Show emotion", type: "T" }, { text: "Be impersonal", type: "F" }] },
            { id: 67, text: "Do you aim for:", options: [{ text: "Logic", type: "T" }, { text: "Harmony", type: "F" }] },
            { id: 68, text: "Which flaw is worse:", options: [{ text: "Being critical", type: "T" }, { text: "Being gullible", type: "F" }] },
            { id: 69, text: "Do you prefer a:", options: [{ text: "Detailed agenda", type: "J" }, { text: "Loose discussion", type: "P" }] },
            { id: 70, text: "Is your leadership:", options: [{ text: "Planned", type: "J" }, { text: "Responsive", type: "P" }] }
        ];

        let currentIndex = 0, answers = {}, db, auth, currentUser, currentType = "", participantName = "", participantEmail = "";

        async function init() {
            const config = JSON.parse(window.__firebase_config || '{}');
            if (config.apiKey) {
                const app = initializeApp(config);
                auth = getAuth(app); db = getFirestore(app);
                onAuthStateChanged(auth, u => currentUser = u);
                await signInAnonymously(auth);
            }
            document.getElementById('start-btn').onclick = startAssessment;
            document.getElementById('prev-btn').onclick = () => { if (currentIndex > 0) { currentIndex--; renderQuestion(); } };
        }

        function startAssessment() {
            const n = document.getElementById('reg-name'), e = document.getElementById('reg-email');
            if (!n.value.trim() || !e.value.trim()) return;
            participantName = n.value.trim(); participantEmail = e.value.trim();
            document.getElementById('registration-card').classList.add('hidden');
            document.getElementById('question-card').classList.remove('hidden');
            document.getElementById('progress-container').classList.remove('hidden');
            document.getElementById('progress-text').classList.remove('hidden');
            renderQuestion();
        }

        function renderQuestion() {
            const q = QUESTIONS[currentIndex];
            document.getElementById('question-text').innerText = q.text;
            document.getElementById('progress-bar').style.width = `${((currentIndex + 1) / QUESTIONS.length) * 100}%`;
            document.getElementById('progress-text').innerText = `Question ${currentIndex + 1} / ${QUESTIONS.length}`;
            document.getElementById('prev-btn').disabled = currentIndex === 0;
            const container = document.getElementById('options-container'); container.innerHTML = '';
            q.options.forEach(o => {
                const b = document.createElement('button');
                b.className = `option-btn w-full text-left p-5 rounded-xl border-2 transition-all flex items-center justify-between ${answers[q.id] === o.type ? 'border-brand-black bg-slate-50 font-semibold' : 'border-slate-100'}`;
                b.innerHTML = `<span>${o.text}</span><span class="text-slate-300">→</span>`;
                b.onclick = () => { answers[q.id] = o.type; if (currentIndex < QUESTIONS.length - 1) { currentIndex++; renderQuestion(); } else { showResults(); } };
                container.appendChild(b);
            });
        }

        async function showResults() {
            document.getElementById('question-card').classList.add('hidden');
            document.getElementById('results-card').classList.remove('hidden');
            document.getElementById('result-display-name').innerText = participantName;
            document.getElementById('result-display-email').innerText = participantEmail;
            
            const c = { E: 0, I: 0, S: 0, N: 0, T: 0, F: 0, J: 0, P: 0 };
            Object.values(answers).forEach(t => c[t]++);
            
            currentType = [c.E >= c.I ? "E" : "I", c.S >= c.N ? "S" : "N", c.T >= c.F ? "T" : "F", c.J >= c.P ? "J" : "P"].join("");
            
            document.getElementById('type-badge').innerText = currentType;
            const profile = LEADERSHIP_DICTIONARY[currentType] || LEADERSHIP_DICTIONARY["INTJ"];
            document.getElementById('type-title').innerText = profile.title;
            
            const g = document.getElementById('scores-grid');
            const metrics = [
                { l: 'E vs I', v: `${c.E}:${c.I}`, c: 'bg-brand-blue' },
                { l: 'S vs N', v: `${c.S}:${c.N}`, c: 'bg-brand-mint' },
                { l: 'T vs F', v: `${c.T}:${c.F}`, c: 'bg-brand-coral' },
                { l: 'J vs P', v: `${c.J}:${c.P}`, c: 'bg-brand-pear' }
            ];
            g.innerHTML = metrics.map(i => `<div class="${i.c} p-4 rounded-xl border border-brand-black flex flex-col items-center"><span class="text-[10px] font-bold text-brand-black uppercase tracking-widest">${i.l}</span><span class="text-lg font-bold text-brand-black">${i.v}</span></div>`).join('');
            
            // Populate static analysis content
            document.getElementById('type-definition').innerText = profile.definition;
            document.getElementById('work-style-analysis').innerText = profile.workStyle;
            
            document.getElementById('download-btn').onclick = () => downloadReport(currentType, c, profile);

            if (db && currentUser) {
                try {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'mbti_logs'), { 
                        participant: participantName, 
                        email: participantEmail, 
                        type: currentType, 
                        timestamp: new Date().toISOString() 
                    });
                } catch (e) { /* silent log failure */ }
            }
        }

        function downloadReport(type, counts, profile) {
            const date = new Date().toLocaleString();
            const content = `METROLINX EXECUTIVE ASSESSMENT
-------------------------------
Date: ${date}
Participant: ${participantName}
Email: ${participantEmail}

Executive profile
-----------------
Type: ${type}
Role designation: ${profile.title}

Scoring breakdown
-----------------
Extraversion vs Introversion: ${counts.E} to ${counts.I}
Sensing vs Intuition: ${counts.S} to ${counts.N}
Thinking vs Feeling: ${counts.T} to ${counts.F}
Judging vs Perceiving: ${counts.J} to ${counts.P}

Type definition
---------------
${profile.definition}

Professional work style
-----------------------
${profile.workStyle}

CONFIDENTIAL - OPERATIONS BUSINESS SERVICES`;

            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = `Executive_Report_${participantName.replace(/\s/g, '_')}.txt`;
            document.body.appendChild(a); a.click(); URL.revokeObjectURL(url);
        }

        window.onload = init;
    </script>
</body>
</html>